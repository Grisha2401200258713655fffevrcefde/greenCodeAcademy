{% extends 'base.html' %}
{% block title %}Профиль{% endblock %}
{% block content %}

<div class="container my-4">
  <div class="row g-4">
    <!-- Левая колонка -->
    <div class="col-md-4">
      <div class="card bg-dark text-light h-100">
        <div class="card-body text-center">
          <img
            src="{{ user.avatar_url or ('https://i.pravatar.cc/150?u=' ~ user.username) }}"
            alt="" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
          <h4 class="mb-1">{{ user.full_name or user.username }}</h4>
          <div class="text-secondary">{{ user.email }}</div>
          <div class="small text-secondary">На сайте с {{ user.created_at.strftime('%d.%m.%Y') }}</div>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm w-100 mt-3">Выйти</a>
        </div>
      </div>
    </div>

    <!-- Правая колонка -->
    <div class="col-md-8">
      <!-- Статистика -->
      <div class="card bg-dark text-light mb-3">
        <div class="card-body">
          <h5 class="mb-3">Статистика</h5>
          <div class="row text-center">
            <div class="col">
              <div class="h4 mb-0">{{ materials_count }}</div>
              <div class="text-secondary">всего материалов</div>
            </div>
            <div class="col">
              <div class="h4 mb-0">{{ theory_count }}</div>
              <div class="text-secondary">теория</div>
            </div>
            <div class="col">
              <div class="h4 mb-0">{{ practice_count }}</div>
              <div class="text-secondary">практика</div>
            </div>
          </div>

          {% if by_lang %}
          <hr class="border-secondary">
          <div class="row text-center">
            {% for lang, cnt in by_lang %}
              <div class="col-6 col-md-4 my-1">
                <span class="badge bg-secondary text-uppercase">{{ lang }}</span>
                <span class="ms-1">{{ cnt }}</span>
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Прогресс -->
      <div class="card bg-dark text-light mb-3">
        <div class="card-body">
          <h5 class="mb-3">Прогресс</h5>
          <div class="progress">
            <div class="progress-bar bg-success"
                 role="progressbar"
                 style="width: {{ user.progress_percent or 0 }}%;"
                 aria-valuenow="{{ user.progress_percent or 0 }}"
                 aria-valuemin="0" aria-valuemax="100">
              {{ user.progress_percent or 0 }}%
            </div>
          </div>
          <div class="text-secondary small mt-2">
            Прогресс обновляется по мере выполнения практик.
          </div>
        </div>
      </div>

      <!-- Редактирование профиля -->
      <div class="card bg-dark text-light mb-3">
        <div class="card-body">
          <h5 class="mb-3">Редактирование профиля</h5>
          <form method="post" novalidate>
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Имя и фамилия</label>
                <input type="text" name="full_name" value="{{ user.full_name or '' }}" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Аватар (URL)</label>
                <input type="url" name="avatar_url" value="{{ user.avatar_url or '' }}" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Новый пароль</label>
                <input type="password" name="new_password" class="form-control" placeholder="Оставьте пустым чтобы не менять">
              </div>
              <div class="col-md-6">
                <label class="form-label">Подтверждение пароля</label>
                <input type="password" name="confirm" class="form-control" placeholder="Повторите новый пароль">
              </div>
            </div>
            <button class="btn btn-success mt-3">Сохранить</button>
          </form>
        </div>
      </div>

      <!-- Мои последние открытые материалы -->
      <div class="card bg-dark text-light">
        <div class="card-body">
          <h5 class="mb-3">Недавно открывали</h5>
          {% if recent %}
            <ul class="list-group list-group-flush">
              {% for r in recent %}
              <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">
                <div>
                  <span class="badge bg-secondary text-uppercase me-2">{{ r.material.language }}</span>
                  <span class="badge {{ 'bg-info' if r.material.type=='theory' else 'bg-warning' }} me-2">{{ r.material.type }}</span>
                  <a class="link-warning fw-semibold" href="{{ url_for('material_detail', material_id=r.material.id) }}">{{ r.material.title }}</a>
                </div>
                <div class="text-nowrap small text-secondary">
                  {{ r.opened_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-secondary">Пока нет.</div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}
